<!DOCTYPE html>
<html>
  <head>
    <title>Razorpay Payment Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
      }
      button {
        background-color: #667eea;
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
      }
      button:hover {
        background-color: #5a6fd8;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
      .info {
        color: blue;
      }
      .order-details {
        background: #e3f2fd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Razorpay Payment Test</h1>

    <div>
      <h3>Create Fresh Order & Pay</h3>
      <button onclick="createAndPay()">Create New Order & Pay</button>
    </div>

    <div id="result"></div>

    <script>
      const API_BASE = "http://localhost:3000/api/v1";
      const JWT_TOKEN =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5M2Q0ODExOGI2MTg5MTQyZTA3YWU5ZCIsImlzQWRtaW4iOmZhbHNlLCJpYXQiOjE3NjU2MzMxODYsImV4cCI6MTc2NTcxOTU4Nn0.trP35DQ4sJnQdvIlRUZB5uZ-4-1pLsPe_scj6Nq9Ej4"; // REPLACE WITH ACTUAL TOKEN

      async function createAndPay() {
        try {
          document.getElementById("result").innerHTML =
            '<div class="info">Creating fresh order...</div>';

          console.log("Using JWT Token:", JWT_TOKEN ? "Present" : "Missing");

          // Create new order
          const orderResponse = await fetch(
            `${API_BASE}/checkout/create-order`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${JWT_TOKEN}`,
              },
              body: JSON.stringify({
                cartItems: [
                  {
                    productId: "6936db601607ea71b8059c99",
                    quantity: 3,
                  },
                  {
                    productId: "6936ddaa1607ea71b8059ca0",
                    quantity: 5,
                  },
                ],
                shippingAddress: {
                  address: "123 Test Street",
                  city: "Mumbai",
                  postalCode: "400001",
                  country: "India",
                },
              }),
            }
          );

          console.log("Order response status:", orderResponse.status);

          if (!orderResponse.ok) {
            const errorText = await orderResponse.text();
            console.error("Order creation failed:", errorText);
            throw new Error(
              `Order creation failed (${orderResponse.status}): ${errorText}`
            );
          }

          const orderData = await orderResponse.json();
          console.log("‚úÖ Fresh order created:", orderData);

          document.getElementById("result").innerHTML = `
                <div class="success">‚úÖ Order Created Successfully!</div>
                <div class="order-details">
                    <strong>Razorpay Order ID:</strong> ${orderData.orderId}<br>
                    <strong>Database Order ID:</strong> ${
                      orderData.order._id
                    }<br>
                    <strong>Amount:</strong> ‚Çπ${(
                      orderData.amount / 100
                    ).toFixed(2)}<br>
                    <strong>Receipt:</strong> ${orderData.receipt}
                </div>
                <div class="info">Opening payment gateway...</div>
            `;

          // Wait a moment then open payment
          setTimeout(async () => {
            await openRazorpayPayment(orderData);
          }, 1000);
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "result"
          ).innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
        }
      }

      async function openRazorpayPayment(orderData) {
        return new Promise((resolve, reject) => {
          try {
            console.log("Opening Razorpay with data:", orderData);

            const options = {
              key: orderData.key,
              amount: orderData.amount,
              currency: orderData.currency,
              order_id: orderData.orderId,
              name: "Test Store",
              description: `Payment for ${orderData.receipt}`,
              prefill: {
                name: orderData.user?.name || "Test User",
                email: orderData.user?.email || "test@example.com",
                contact: orderData.user?.phone || "9999999999",
              },
              theme: {
                color: "#667eea",
              },
              handler: function (response) {
                console.log("Payment successful:", response);
                handlePaymentSuccess(response);
                resolve(response);
              },
              modal: {
                ondismiss: function () {
                  console.log("Payment modal dismissed");
                  document.getElementById("result").innerHTML =
                    '<div class="error">Payment cancelled by user</div>';
                  reject(new Error("Payment cancelled"));
                },
              },
            };

            console.log("Razorpay options:", options);

            if (!options.key || !options.amount || !options.order_id) {
              throw new Error("Invalid Razorpay configuration");
            }

            if (typeof Razorpay === "undefined") {
              throw new Error(
                "Razorpay SDK not loaded. Check internet connection."
              );
            }

            const rzp = new Razorpay(options);

            rzp.on("payment.failed", function (response) {
              console.error("Payment failed:", response.error);
              document.getElementById("result").innerHTML = `
                        <div class="error">‚ùå Payment Failed</div>
                        <div class="error">Reason: ${response.error.description}</div>
                        <div class="error">Code: ${response.error.code}</div>
                    `;
              reject(response.error);
            });

            rzp.open();
          } catch (error) {
            console.error("Error opening Razorpay:", error);
            document.getElementById(
              "result"
            ).innerHTML = `<div class="error">‚ùå Razorpay Error: ${error.message}</div>`;
            reject(error);
          }
        });
      }

      async function handlePaymentSuccess(response) {
        try {
          document.getElementById("result").innerHTML =
            '<div class="info">üí≥ Payment successful! Verifying with server...</div>';
          console.log("Payment response received:", response);

          const verificationPayload = {
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
          };

          console.log("Sending verification data:", verificationPayload);

          const verifyResponse = await fetch(
            `${API_BASE}/checkout/verify-payment`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(verificationPayload),
            }
          );

          console.log("Verification response status:", verifyResponse.status);

          if (!verifyResponse.ok) {
            const errorText = await verifyResponse.text();
            throw new Error(
              `Verification request failed: ${verifyResponse.status} - ${errorText}`
            );
          }

          const verifyData = await verifyResponse.json();
          console.log("Verification result:", verifyData);

          if (verifyData.success) {
            document.getElementById("result").innerHTML = `
                    <div class="success">
                        <h4>üéâ Payment Completed Successfully!</h4>
                        <div class="order-details">
                            <strong>Order ID:</strong> ${
                              verifyData.order._id
                            }<br>
                            <strong>Payment ID:</strong> ${
                              response.razorpay_payment_id
                            }<br>
                            <strong>Status:</strong> ${
                              verifyData.order.status
                            }<br>
                            <strong>Amount:</strong> ‚Çπ${
                              verifyData.order.totalPrice
                            }<br>
                            <strong>Email Sent:</strong> ${
                              verifyData.emailSent ? "‚úÖ Yes" : "‚ùå No"
                            }
                        </div>
                    </div>
                `;
          } else {
            document.getElementById("result").innerHTML = `
                    <div class="error">‚ùå Payment Verification Failed</div>
                    <div class="error">Reason: ${verifyData.message}</div>
                `;
          }
        } catch (error) {
          console.error("Verification error:", error);
          document.getElementById("result").innerHTML = `
                <div class="error">‚ùå Verification Error: ${error.message}</div>
                <div class="error">Please check console for details</div>
            `;
        }
      }

      // Test server connection
      window.onload = async function () {
        try {
          const response = await fetch(`${API_BASE}/products`);
          if (response.ok) {
            console.log("‚úÖ Server connection OK");
            document.getElementById("result").innerHTML =
              '<div class="success">üåê Server connection successful. Ready to create order!</div>';
          } else {
            throw new Error(`Server responded with status: ${response.status}`);
          }
        } catch (error) {
          console.error("Connection test failed:", error);
          document.getElementById("result").innerHTML = `
                <div class="error">‚ùå Server connection failed. Make sure your server is running on http://localhost:3000</div>
            `;
        }
      };
    </script>
  </body>
</html>
